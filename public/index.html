<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>A REALTIME TWITTER THING</title>

    <script src="http://fb.me/react-0.12.2.min.js"></script>
    <script src="http://fb.me/JSXTransformer-0.12.2.js"></script>


    <link rel="stylesheet" type="text/css" href="stylesheets/style.css"/>
    <script type="text/jsx">


        var Tweets = React.createClass({
            getInitialState: function() {
                return {
                    tweets: [],
                    tweetStream: tweetStream
                };
            },
            componentDidMount: function() {
                this.state.tweetStream.addListener(function(tweet){
                    var oldTweets = this.state.tweets;
                    oldTweets.unshift(tweet);
                    this.setState({tweets: oldTweets});
                }.bind(this));

            },
            render: function() {
                var tweets = this.state.tweets.map(function(tweet) {
                    return (
                            <li className="tweet">
                                    <img src={tweet.user.profile_image_url} />
                                    <span>{tweet.user.name} - </span>
                                    <a href={ "https://twitter.com/" + tweet.user.screen_name}>@{tweet.user.screen_name}</a>
                                    <p>{tweet.text}</p>
                            </li>
                    );
                });
                return (
                    <ul id="tweets">
                        {tweets}
                    </ul>
                );
            }
        });

        React.render(
            < Tweets />,
            document.getElementById('tweets-pre')
        );

    </script>
    <script>

        var TweetStream = (function() {

            var ws;

            function TweetStream (wsURL) {
                ws = new WebSocket(wsURL);

                this.listeners = [];

                ws.onmessage = function (event) {
                    var parsed = JSON.parse(event.data);
                    this.listeners.forEach(function(listen) {
                        listen(parsed);
                    });
                }.bind(this);
            }

            TweetStream.prototype.addListener = function addListener(cb) {
                this.listeners.push(cb);
            };

            TweetStream.prototype.send = function(message, value) {
                ws.send(message, value);
            };

            return TweetStream;
        })();


        var tweetStream = new TweetStream(location.origin.replace(/^http/, 'ws'));

        document.addEventListener('DOMContentLoaded', function() {
            (function tweetRateUpdater() {
                var tweetRate = document.getElementById('tweetRate');

                tweetRate.addEventListener('change', function onTweetRateChange(e) {

                    var tweetRateOutput = document.getElementById('tweetRateOutput');
                    tweetRateOutput.value = e.currentTarget.value;
                    tweetStream.send(
                            JSON.stringify(
                                    {
                                        type: 'rate',
                                        rate: tweetRateOutput.value
                                    }
                            )
                    );
                });
            })();
        });
    </script>
</head>
<body>
    <div id="tweetSettings">
        <label for='tweetRate'>Max tweets per second:</label>
        <input type='range' id='tweetRate' min='1' value='1' max='10' step='1'>
        <output for='tweetRate' id='tweetRateOutput'>1</output>
    </div>

    <section class="tweetsContainer">
        <ul id="tweets-pre">

        </ul>
    </section>
</body>
</html>
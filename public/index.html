<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <meta http-equiv="Content-Language" content="en" />
    <title>A REALTIME TWITTER THING</title>

    <script src="http://fb.me/react-with-addons-0.12.2.js"></script>
    <script src="http://fb.me/JSXTransformer-0.12.2.js"></script>


    <link rel="stylesheet" type="text/css" href="stylesheets/style.css"/>
    <script type="text/jsx">

        var ReactCSSTransitionGroup = React.addons.CSSTransitionGroup;


        var Tweets = React.createClass({
            getInitialState: function() {
                return {
                    tweets: [],
                    tweetStream: tweetStream,
                    tweetFilter: tweetFilter
                };
            },
            componentDidMount: function() {
                this.state.tweetStream.addListener(function(tweet){
                    var oldTweets = this.state.tweets;
                    oldTweets.unshift(tweet);
                    this.setState({tweets: oldTweets});
                }.bind(this));

                //if performance gets to be a problem, we can just disable this, the tweets will be forcing a state update often enough to make up for not listening to this event
                this.state.tweetFilter.addListener(function(message) {
                    if (message === 'languageFilterChange') {
                        this.forceUpdate();
                    }
                }.bind(this));
            },
            render: function() {
                var tweets = [];
                this.state.tweets.some(function(tweet) {
                    if (tweets.length >= 20) {
                        return true;
                    }
                    if (this.state.tweetFilter.tweetMatchesFilter(tweet)) {
                        tweets.push(
                                <li className="tweet" key={tweet.id_str}>
                                    <img src={tweet.user.profile_image_url} />
                                    <span>{tweet.user.name} - </span>
                                    <a href={ "https://twitter.com/" + tweet.user.screen_name}>@{tweet.user.screen_name}</a>
                                    <p>{tweet.text}</p>
                                </li>
                        );
                    }
                }.bind(this));
                return (
                    <ul id="tweets">
                        <ReactCSSTransitionGroup transitionName="animFadeIn">
                        {tweets}
                        </ReactCSSTransitionGroup>
                    </ul>
                );
            }
        });

        React.render(
            < Tweets />,
            document.getElementById('tweetsContainer')
        );

        var widthMixins = {
            getInitialState: function () {
                return {
                    myWidth: 0
                };
            },
            updateDimensions: function () {
                this.setState({myWidth: this.getDOMNode().offsetWidth});
            },
            componentDidMount: function () {
                this.updateDimensions();
                window.addEventListener('resize', this.updateDimensions);
            },
            componentWillUnmount: function () {
                window.removeEventListener('resize', this.updateDimensions);
            }
        };

        var statisticsMixin = {
            getInitialState: function () {
                return {
                    contents: {}
                };
            },
            getChildWidth: function(count, sum, width) {
                return (( count / sum) * width ) || 0;
            },
            getInfoForRender: function(contents) {
                var contentsList = Object.keys(contents).map(function (contentName) {
                    return [contentName, contents[contentName]];
                }).sort(function (a, b) {
                    return b[1] - a[1];
                }).slice(0, 14);

                var contentsSum = contentsList.reduce(function (sum, content) {
                    return sum + content[1];
                }, 0);

                return {
                    list: contentsList,
                    sum: contentsSum
                };
            },
            getListForRender: function(contents) {
                var contentsList = Object.keys(contents).map(function (contentName) {
                    return [contentName, contents[contentName]];
                }).sort(function (a, b) {
                    return b[1] - a[1];
                }).slice(0, 14);

                return contentsList;
            },
            getSum: function(contents) {
                var contentsSum = contents.reduce(function (sum, content) {
                    return sum + content[1];
                }, 0);

                return contentsSum;
            }
        };

        var Tags = React.createClass({
            mixins: [statisticsMixin, widthMixins],
            getInitialState: function() {
                return {
                    tweetStream: tweetStream,
                    tweetFilter: tweetFilter
                };
            },
            componentDidMount: function() {
                this.state.tweetStream.addListener(function(tweet){
                    var oldTags = this.state.contents;
                    var tags = tweet.entities.hashtags;
                    tags.forEach(function(tag) {
                        oldTags[tag.text] = (oldTags[tag.text] || 0) + 1
                    });
                    this.setState({contents: oldTags});
                }.bind(this));
            },
            render: function() {
                var sortedList = this.getListForRender(this.state.contents);
                var sumOfList = this.getSum(sortedList);
                var renderedList = sortedList.map(function(tag) {
                    var childWidth = this.getChildWidth(tag[1], sumOfList, this.state.myWidth);
                    return (
                            <TagsItem key={tag[0]} tag={tag[0]} count={tag[1]} active={false} mwidth={childWidth}/>
                    );
                }.bind(this));
                if (renderedList.length === 0 ) {
                    renderedList.push(
                            <li><span>No Tags to show yet</span></li>
                    )
                }
                return (
                        <div>
                            <label>Tags:</label>
                            <ul  className="tags">
                                {renderedList}
                            </ul>
                        </div>
                );
            }
        });

        var TagsItem = React.createClass({
            render: function() {
                var classText = this.props.active ? 'tag-active' : 'tag';
                var style = {
                    'backgroundSize': this.props.mwidth.toString() + 'px 100%'
                };
                return (
                        <li className={classText} style={style}>
                            <span>{this.props.tag}:</span>
                            <span>{this.props.count}</span>
                        </li>
                );
            }
        });

        var LanguageItem = React.createClass({
            setLanguage: function() {
                tweetFilter.setLanguageFilter(this.props.language);
            },
            render: function() {
                var classText = this.props.active ? 'language-active' : 'language';
                var style = {
                    'backgroundSize': this.props.mwidth.toString() + 'px 100%'
                };
                return (
                        <li onClick={this.setLanguage} className={classText} style={style}>
                            <span>{this.props.language}:</span>
                            <span>{this.props.count}</span>
                        </li>
                );
            }
        });

        var Languages = React.createClass({
            mixins: [statisticsMixin, widthMixins],
            getInitialState: function () {
                return {
                    tweetStream: tweetStream,
                    tweetFilter: tweetFilter
                };
            },
            componentDidMount: function () {
                this.state.tweetStream.addListener(
                        function (tweet) {
                            var contents = this.state.contents;
                            var newContents = [tweet.lang];
                            newContents.forEach(function (content) {
                                contents[content] = (contents[content] || 0) + 1
                            });
                            this.setState({contents: contents});
                        }.bind(this));

                this.state.tweetFilter.addListener(
                        function (message, data) {
                            if (message === 'languageFilterChange') {
                                this.setState({activeLanguage: data});
                            }
                        }.bind(this));
            },
            render: function () {
                var sortedList = this.getListForRender(this.state.contents);
                var sumOfList = this.getSum(sortedList);
                var renderedList = sortedList.map(function (tag) {
                    var isActive = this.state.activeLanguage === tag[0];
                    var childWidth = this.getChildWidth(tag[1], sumOfList, this.state.myWidth);
                    return (
                            <LanguageItem  key={tag[0]} language={tag[0]} count={tag[1]} active={isActive} mwidth={childWidth}/>
                    );
                }.bind(this));
                if (renderedList.length === 0 ) {
                    renderedList.push(
                            <li><span>No languages to show yet</span></li>
                    )
                }
                return (
                        <div>
                            <label>Languages:</label>
                            <ul className="languages">
                                {renderedList}
                            </ul>
                        </div>
                );
            }
        });

        var Statistics = React.createClass({
            render: function() {
                return (
                        <div>
                            < Languages />
                            <Tags/>
                        </div>
                );
            }
        });

        React.render(
            < Statistics />,
            document.getElementById('statistics')
        );

    </script>
    <script>

        var TweetStream = (function() {

            var ws;

            function TweetStream (wsURL) {
                ws = new WebSocket(wsURL);

                this.listeners = [];

                ws.onmessage = function (event) {
                    var parsed = JSON.parse(event.data);
                    this.listeners.forEach(function(listen) {
                        listen(parsed);
                    });
                }.bind(this);
            }

            TweetStream.prototype.addListener = function addListener(cb) {
                this.listeners.push(cb);
            };

            TweetStream.prototype.send = function(message, value) {
                ws.send(message, value);
            };

            return TweetStream;
        })();

        var TweetFilter = (function () {
            function TweetFilter() {
                this.listeners = [];
                this.languageFilter = null;
            }

            TweetFilter.prototype.addListener = function addListener(cb) {
                this.listeners.push(cb);
            };

            TweetFilter.prototype.dispatchEvent = function dispatchEvent(message, data) {
                this.listeners.forEach(function(cb) {
                    cb(message, data);
                });
            };

            TweetFilter.prototype.setLanguageFilter = function(languageCode) {
                this.languageFilter = languageCode;
                this.dispatchEvent('languageFilterChange', this.languageFilter);
            };

            TweetFilter.prototype.tweetMatchesFilter = function(tweet) {
                if (this.languageFilter !== null ) {
                    return tweet.lang === this.languageFilter;
                } else {
                    return true;
                }
            };

            return TweetFilter;
        })();

        var tweetFilter = new TweetFilter();

        var tweetStream = new TweetStream(location.origin.replace(/^http/, 'ws'));

        function tweetRateUpdater() {
            var tweetRate = document.getElementById('tweetRate');

            tweetRate.addEventListener('change', function onTweetRateChange(e) {

                var tweetRateOutput = document.getElementById('tweetRateOutput');
                tweetRateOutput.value = e.currentTarget.value;
                tweetStream.send(
                        JSON.stringify(
                                {
                                    type: 'rate',
                                    rate: tweetRateOutput.value
                                }
                        )
                );
            });
        }

        document.addEventListener('DOMContentLoaded', function() {
            tweetRateUpdater();
        });

    </script>
</head>
<body>
    <div id="tweetSettings">
        <label for='tweetRate'>Max tweets per second:</label>
        <input type='range' id='tweetRate' min='1' value='1' max='10' step='1'>
        <output for='tweetRate' id='tweetRateOutput'>1</output>
    </div>

    <section id="tweetsContainer">
        <ul id="tweets">
            <li class="tweet">
            </li>
        </ul>
    </section>
    <section class="statistics" id="statistics">
    </section>
</body>
</html>
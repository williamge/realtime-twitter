<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>A REALTIME TWITTER THING</title>

    <script src="http://fb.me/react-0.12.2.min.js"></script>
    <script src="http://fb.me/JSXTransformer-0.12.2.js"></script>


    <link rel="stylesheet" type="text/css" href="stylesheets/style.css"/>
    <script type="text/jsx">


        var Tweets = React.createClass({
            getInitialState: function() {
                return {
                    tweets: [],
                    tweetStream: tweetStream,
                    tweetFilter: tweetFilter
                };
            },
            componentDidMount: function() {
                this.state.tweetStream.addListener(function(tweet){
                    var oldTweets = this.state.tweets;
                    oldTweets.unshift(tweet);
                    this.setState({tweets: oldTweets});
                }.bind(this));

                //if performance gets to be a problem, we can just disable this, the tweets will be forcing a state update often enough to make up for not listening to this event
                this.state.tweetFilter.addListener(function(message) {
                    if (message === 'languageFilterChange') {
                        this.forceUpdate();
                    }
                }.bind(this));
            },
            render: function() {
                var tweets = [];
                this.state.tweets.some(function(tweet) {
                    if (tweets.length >= 20) {
                        return true;
                    }
                    if (this.state.tweetFilter.tweetMatchesFilter(tweet)) {
                        tweets.push(
                                <li className="tweet">
                                    <img src={tweet.user.profile_image_url} />
                                    <span>{tweet.user.name} - </span>
                                    <a href={ "https://twitter.com/" + tweet.user.screen_name}>@{tweet.user.screen_name}</a>
                                    <p>{tweet.text}</p>
                                </li>
                        );
                    }
                }.bind(this));
                return (
                    <ul id="tweets">
                        {tweets}
                    </ul>
                );
            }
        });

        React.render(
            < Tweets />,
            document.getElementById('tweetsContainer')
        );

        var Tags = React.createClass({
            getInitialState: function() {
                return {
                    tags: {},
                    tweetStream: tweetStream
                };
            },
            componentDidMount: function() {
                this.state.tweetStream.addListener(function(tweet){
                    var oldTags = this.state.tags;
                    var tags = tweet.entities.hashtags;
                    tags.forEach(function(tag) {
                        oldTags[tag.text] = (oldTags[tag.text] || 0) + 1
                    });
                    this.setState({tags: oldTags});
                }.bind(this));
            },
            render: function() {
                var tags = this.state.tags;
                var tagsList = Object.keys(tags).map(function(tagName) {
                    return [tagName, tags[tagName]];
                }).sort(function(a, b) {
                    return b[1] - a[1];
                }).slice(0, 14);

                var renderedList = tagsList.map(function(tag) {
                   return (
                           <li>
                                   <span>{'#' + tag[0]}:</span>
                                   <span>{tag[1]}</span>
                           </li>
                   ) ;
                });
                return (
                    <div>
                        <label>Tags:</label>
                            <ul>
                                {renderedList}
                            </ul>
                    </div>
                );
            }
        });

        var LanguageItem = React.createClass({
            setLanguage: function() {
                tweetFilter.setLanguageFilter(this.props.language);
            },
            render: function() {
                var classText = this.props.active ? 'language-active' : 'language';
                return (
                        <li onClick={this.setLanguage} className={classText}>
                            <span>{this.props.language}:</span>
                            <span>{this.props.count}</span>
                        </li>
                );
            }
        });

        var Languages = React.createClass({
            getInitialState: function() {
                return {
                    languages: {},
                    tweetStream: tweetStream,
                    tweetFilter: tweetFilter,
                    activeLanguage: ''
                };
            },
            componentDidMount: function() {
                this.state.tweetStream.addListener(function(tweet){
                    var oldLanguages = this.state.languages;
                    var languages = [tweet.lang];
                    languages.forEach(function(language) {
                        oldLanguages[language] = (oldLanguages[language] || 0) + 1
                    });
                    this.setState({languages: oldLanguages});
                }.bind(this));

                this.state.tweetFilter.addListener(function(message, data){
                    if (message === 'languageFilterChange') {
                        this.setState({activeLanguage: data});
                    }
                }.bind(this));
            },
            render: function() {
                var languages = this.state.languages;
                var languagesList = Object.keys(languages).map(function(languageName) {
                    return [languageName, languages[languageName]];
                }).sort(function(a, b) {
                    return b[1] - a[1];
                }).slice(0, 14);

                var renderedList = languagesList.map(function(tag) {
                    var isActive = this.state.activeLanguage === tag[0];
                    return (
                            <LanguageItem language={tag[0]} count={tag[1]} active={isActive} />
                    ) ;
                }.bind(this));
                return (
                        <div>
                            <label>Languages:</label>
                            <ul>
                                {renderedList}
                            </ul>
                        </div>
                );
            }
        });

        var Statistics = React.createClass({
            render: function() {
                return (
                        <div>
                            < Languages />
                        </div>
                );
            }
        });

        React.render(
            < Statistics />,
            document.getElementById('statistics')
        );

    </script>
    <script>

        var TweetStream = (function() {

            var ws;

            function TweetStream (wsURL) {
                ws = new WebSocket(wsURL);

                this.listeners = [];

                ws.onmessage = function (event) {
                    var parsed = JSON.parse(event.data);
                    this.listeners.forEach(function(listen) {
                        listen(parsed);
                    });
                }.bind(this);
            }

            TweetStream.prototype.addListener = function addListener(cb) {
                this.listeners.push(cb);
            };

            TweetStream.prototype.send = function(message, value) {
                ws.send(message, value);
            };

            return TweetStream;
        })();

        var TweetFilter = (function () {
            function TweetFilter() {
                this.listeners = [];
                this.languageFilter = null;
            }

            TweetFilter.prototype.addListener = function addListener(cb) {
                this.listeners.push(cb);
            };

            TweetFilter.prototype.dispatchEvent = function dispatchEvent(message, data) {
                this.listeners.forEach(function(cb) {
                    cb(message, data);
                });
            };

            TweetFilter.prototype.setLanguageFilter = function(languageCode) {
                this.languageFilter = languageCode;
                this.dispatchEvent('languageFilterChange', this.languageFilter);
            };

            TweetFilter.prototype.tweetMatchesFilter = function(tweet) {
                if (this.languageFilter !== null ) {
                    return tweet.lang === this.languageFilter;
                } else {
                    return true;
                }
            };

            return TweetFilter;
        })();

        var tweetFilter = new TweetFilter();

        var tweetStream = new TweetStream(location.origin.replace(/^http/, 'ws'));

        function tweetRateUpdater() {
            var tweetRate = document.getElementById('tweetRate');

            tweetRate.addEventListener('change', function onTweetRateChange(e) {

                var tweetRateOutput = document.getElementById('tweetRateOutput');
                tweetRateOutput.value = e.currentTarget.value;
                tweetStream.send(
                        JSON.stringify(
                                {
                                    type: 'rate',
                                    rate: tweetRateOutput.value
                                }
                        )
                );
            });
        }

        document.addEventListener('DOMContentLoaded', function() {
            tweetRateUpdater();
        });

    </script>
</head>
<body>
    <div id="tweetSettings">
        <label for='tweetRate'>Max tweets per second:</label>
        <input type='range' id='tweetRate' min='1' value='1' max='10' step='1'>
        <output for='tweetRate' id='tweetRateOutput'>1</output>
    </div>

    <section id="tweetsContainer">
        <ul id="tweets">
            <li class="tweet">
            </li>
        </ul>
    </section>
    <section class="statistics" id="statistics">
    </section>
</body>
</html>